FROM python:3.12-alpine

RUN apk update && apk upgrade

COPY ./requirements.txt /requirements.txt

RUN apk add --no-cache libxml2 libxslt \
    && apk add --no-cache --virtual .build-deps build-base libxml2-dev libxslt-dev \
    && pip install -r /requirements.txt gunicorn \
    && apk del .build-deps

COPY ./anubis /code/anubis
RUN mkdir /code/site

WORKDIR /code/anubis
ENV PYTHONPATH=/code
ENV GUNICORN_CMD_ARGS="--bind=0.0.0.0:8000 --workers=1 --thread=4 --worker-class=gthread --forwarded-allow-ips='*' --access-logfile -"
CMD ["gunicorn", "main:app"]

VOLUME ["/code/site"]
