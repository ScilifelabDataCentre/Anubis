{% extends 'base.html' %}

{% block head_title %}{{ call['identifier'] }}{% endblock %}

{% block body_title %}
{{ call['title'] }}
<small class="text-muted ml-3">Call for submissions</small>
{% endblock %}

{% block main %}
{% if g.is_admin %}
<div class="row">
  <div class="col-md-2 font-weight-bold text-right">Opens</div>
  <div class="col-md">
    {% if call['opens'] %}
    {{ call['opens'] }}
    {% else %}
    Not set
    {% endif %}
  </div>
</div>
{% endif %}
<div class="row">
  <div class="col-md-2 font-weight-bold text-right">Closes</div>
  <div class="col-md">
    <span class="mr-4">{{ call['closes'] or '-' }}</span>
    {{ macros.badge_call_closes(call) }}
  </div>
</div>
<div class="row">
  <div class="col-md-2 font-weight-bold text-right">Identifier</div>
  <div class="col-md">{{ call['identifier'] }}</div>
</div>
{% if g.is_admin %}
<div class="row">
  <div class="col-md-2 font-weight-bold text-right">Submissions</div>
  <div class="col-md">
    <a href="{{ url_for('submissions.call', cid=call['identifier']) }}">
      <span class="badge badge-primary">{{ call['tmp'].submissions_count }}
    </span></a>
  </div>
</div>
<div class="row">
  <div class="col-md-2 font-weight-bold text-right">Reviewers</div>
  <div class="col-md">
    {% for reviewer in sorted(call['reviewers']) %}
    <span class="mr-3">
      <a href="{{ url_for('user.display', username=reviewer) }}">
        {{ reviewer }}</a>
      {% if reviewer in call['chairs'] %}
      (chair)
      {% endif %}
    </span>
    {% endfor %}
  </div>
</div>
{% endif %} {# if g.is_admin #}
{% if g.current_user %}
<div class="row">
  <div class="col-md-2 font-weight-bold text-right">My submissions</div>
  <div class="col-md">
    <a href="{{ url_for('submissions.user_call', username=g.current_user['username'], cid=call['identifier']) }}">
      <span class="badge badge-primary">{{ call['tmp'].my_submissions_count }}
    </span></a>
  </div>
</div>
{% endif %} {# if g.current_user #}
<div class="row my-3">
  <div class="col-md-2 font-weight-bold text-right">Description</div>
  <div class="col-md">
    <div class="card mt-2">
      <div class="card-body">
        {{ call.get('description') | markdown }}
      </div>
    </div>
  </div>
</div>

<div class="row my-3">
  <div class="col-md-2 font-weight-bold text-right">Documents</div>
  <div class="col-md">
    {% for document in call.get('documents', []) %}
    <div class="card mt-2">
      <div class="card-header">
        <div class="row">
          <div class="col-md">
            <span class="font-weight-bold">{{ document['name'] }}</span>
            <a href="{{ url_for('call.document', cid=call['identifier'], documentname=document['name']) }}"
               role="button" class="btn btn-secondary btn-sm ml-4">
              Download
              ({{ call['_attachments'][document['name']]['length'] | thousands }} bytes)            </a>
          </div>
          {% if g.is_admin %}
          <div class="col-md text-right">
            <form action="{{ url_for('.delete_document', cid=call['identifier'], documentname=document['name']) }}"
	          method="POST">
	      {{ csrf_token() }}
	      <input type="hidden" name="_http_method" value="DELETE">
	      <button type="submit" class="btn btn-sm btn-danger"
		      onclick="return confirm('Really delete the document {{ document['name'] }}?')">
	        Delete</button>
            </form>
          </div>
          {% endif %} {# if g.is_admin #}
        </div>
      </div>
      {% if document.get('description') %}
      <div class="card-body">
        {{ document.get('description') | markdown }}
      </div>
      {% endif %}
    </div>
    {% endfor %} {# for document in call.get('documents', []) #}

    {% if g.is_admin %}
    <div class="card mt-2">
      <div class="card-body">
        <form action="{{ url_for('.add_document', cid=call['identifier']) }}"
              enctype="multipart/form-data"
	      method="POST">
	  {{ csrf_token() }}
	  <div class="form-group">
            <div class="custom-file">
              <input type="file" id="document" name="document"
	             class="custom-file-input">
              <label class="custom-file-label" for="document">
                Choose document</label>
            </div>
          </div>
	  <div class="form-group">
	    <textarea id="document_description" name="document_description"
		      class="form-control"
		      aria-describedby="document_descriptionHelp"></textarea>
	    <small id="document_descriptionHelp" class="form-text text-muted">
	      <div class="row">
		<div class="col-md">
		  Short description of the document.
		</div>
		<div class="col-md-4 text-right">
		  Formatted using 
		  <a href="{{ config['MARKDOWN_URL'] }}">Markdown</a>.
		</div>
	      </div>
	    </small>
          </div>
	  <div class="form-group">
	    <button type="submit" class="btn btn-btn-sm btn-primary mt-2">
	      Add document</button>
          </div>
        </form>
      </div>
    </div>
    {% endif %} {# if g.is_admin #}
  </div>
</div>

<div class="row">
  <div class="col-md-2 font-weight-bold text-right">Inputs</div>
  <div class="col-md">
    {% for field in call['fields'] %}
    <div class="card mt-2">
      <div class="card-body">
	<div class="row">
	  {% if g.is_admin %}
	  <div class="col-md-2 font-weight-bold">{{ field['identifier'] }}</div>
	  {% endif %} {# if g.is_admin #}
	  <div class="col-md-2">
	    {{ field['title'] }}
	  </div>
	  <div class="col-md">
	    {% if field.get('required') %}
	    <strong>Required!</strong>
	    {% endif %}
	    {% if field.get('maxlength') %}
	    Maximum {{ field['maxlength'] }} characters.
	    {% endif %}
	    <br>
	    {{ field.get('description') | markdown }}
	  </div>
	  {% if call['tmp'].is_editable %}
	  <div class="col-md-2">
	    <div>
	      <button type="button" class="btn btn-block btn-sm btn-primary"
		      data-toggle="modal"
		      data-target="#{{ field['identifier'] }}-Modal">
		Edit
	      </button>
	    </div>
	    <div class="mt-2">
	      <form action="{{ url_for('.edit_field', cid=call['identifier'], fid=field['identifier']) }}"
		    method="POST">
		{{ csrf_token() }}
		<input type="hidden" name="_http_method" value="DELETE">
		<button type="submit" class="btn btn-block btn-sm btn-danger"
			onclick="return confirm('Really delete field {{ field['identifier'] }}?')">
		  Delete</button>
	      </form>
	    </div>
	  </div>
	  {% endif %} {# if call['tmp'].is_editable #}
	</div>
      </div>
    </div>
    {% endfor %}
    {% if call['tmp'].is_editable %}
    <div class="card mt-2">
      <div class="card-body">
	{% for field_type in constants.INPUT_FIELD_TYPES %}
	<button type="button" class="btn btn-primary mr-3"
		data-toggle="modal" data-target="#_{{ field_type }}Modal">
	  Add {{ field_type }} field
	</button>
	{% endfor %} {# for field_type in constants.INPUT_FIELD_TYPES #}
      </div>
    </div>
    {% endif %} {# if call['tmp'].is_editable #}
  </div>
</div>

{% if call['tmp'].is_editable %}

{% for field_type in constants.INPUT_FIELD_TYPES %}
{# Modals to add inputs field. #}
<div class="modal fade" id="_{{ field_type }}Modal" tabindex="-1"
     role="dialog" aria-labelledby="_{{ field_type }}ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <form action="{{ url_for('.add_field', cid=call['identifier']) }}"
	    method="POST">
	{{ csrf_token() }}
	<input type="hidden" name="type" value="{{ field_type }}">
	<div class="modal-header">
          <h5 class="modal-title" 
	      id="_{{ field_type }}ModalLabel">Add {{ field_type }} field</h5>
          <button type="button" class="close"
		  data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
	</div>
	<div class="modal-body">
	  <div class="form-group row">
	    <label for="identifier" class="col-md-2 col-form-label text-right">
	      Identifier</label>
	    <div class="col-md">
	      <input type="text" id="identifier" name="identifier"
		     class="form-control"
		     aria-describedby="identifierHelp">
	      <small id="identifierHelp" class="form-text text-muted">
		<strong>Required!</strong>
		<br>
		Identifier for the field. It cannot be changed.
	      </small>
	    </div>
	  </div>
	  <div class="form-group row">
	    <label for="title" class="col-md-2 col-form-label text-right">
	      Title</label>
	    <div class="col-md">
	      <input type="text" id="title" name="title"
		     class="form-control"
		     aria-describedby="titleHelp">
	      <small id="titleHelp" class="form-text text-muted">
		Descriptive title; the identifier will be used if not set.
	      </small>
	    </div>
	  </div>
	  <div class="form-group row">
	    <label for="required" class="col-md-2 col-form-label text-right">
	      Required</label>
	    <div class="col-md">
	      <div class="form-check">
		<input type="checkbox" id="required" name="required"
		       class="form-check-input"
		       aria-describedby="requiredHelp"
		       value="true">
		<label class="form-check-label" for="required">Yes</label>
	      </div>
	      <small id="requiredHelp" class="form-text text-muted">
		Is a field value required for a valid submission?
	      </small>
	    </div>
	  </div>
	  <div class="form-group row">
	    <label for="description" class="col-md-2 col-form-label text-right">
	      Description</label>
	    <div class="col-md">
	      <textarea id="description" name="description"
			class="form-control"
			aria-describedby="descriptionHelp"></textarea>
	      <small id="descriptionHelp" class="form-text text-muted">
		<div class="row">
		  <div class="col-md">
		    Short description of the information to be entered
		    in the field.
		  </div>
		  <div class="col-md-4 text-right">
		    Formatted using 
		    <a href="{{ config['MARKDOWN_URL'] }}">Markdown</a>.
		  </div>
		</div>
	      </small>
	    </div>
	  </div>
	  {% if field_type in (constants.TEXT, constants.LINE) %}
	  <div class="form-group row">
	    <label for="maxlength" class="col-md-2 col-form-label text-right">
	      Maxlength</label>
	    <div class="col-md">
	      <input type="text" id="maxlength" name="maxlength"
		     class="form-control"
		     aria-describedby="maxlengthHelp">
	      <small id="maxlengthHelp" class="form-text text-muted">
		Max number of characters.
	      </small>
	    </div>
	  </div>	
	  {% endif %} {# if field_type in (constants.TEXT, constants.LINE) #}
	</div>
	<div class="modal-footer">
          <button type="button" class="btn btn-secondary"
		  data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
	</div>
      </form>
    </div>
  </div>
</div>
{% endfor %} {# for field_type in constants.INPUT_FIELD_TYPES #}

{% for field in call['fields'] %}
<div class="modal fade" id="{{ field['identifier'] }}-Modal" tabindex="-1" 
     role="dialog" aria-labelledby="{{ field['identifier'] }}-ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <form action="{{ url_for('.edit_field', cid=call['identifier'], fid=field['identifier']) }}"
	    method="POST">
	{{ csrf_token() }}
	<div class="modal-header">
          <h5 class="modal-title" id="{{ field['identifier'] }}-ModalLabel">
	    Edit {{ field['type'] }} field</h5>
          <button type="button" class="close"
		  data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
	</div>
	<div class="modal-body">
	  <input type="hidden" name="type" value="text">
	  <div class="form-group row">
	    <label for="{{ field['identifier'] }}-identifier" 
		   class="col-md-2 col-form-label text-right">
	      Identifier</label>
	    <div class="col-md">
	      <input type="text" id="{{ field['identifier'] }}-identifier"
		     class="form-control" readonly
		     aria-describedby="{{ field['identifier'] }}-identifierHelp"
		     value="{{ field['identifier'] }}">
	      <small id="{{ field['identifier'] }}-identifierHelp"
		     class="form-text text-muted">
		<strong>Required!</strong>
		<br>
		Identifier for the field. It cannot be changed.
	      </small>
	    </div>
	  </div>
	  <div class="form-group row">
	    <label for="{{ field['identifier'] }}-title" 
		   class="col-md-2 col-form-label text-right">
	      Title</label>
	    <div class="col-md">
	      <input type="text" id="{{ field['identifier'] }}-title"
		     name="title"
		     class="form-control"
		     aria-describedby="{{ field['identifier'] }}-titleHelp"
		     value="{{ field.get('title') or '' }}">
	      <small id="{{ field['identifier'] }}-titleHelp"
		     class="form-text text-muted">
		Descriptive title; the identifier will be used if not set.
	      </small>
	    </div>
	  </div>
	  <div class="form-group row">
	    <label for="{{ field['identifier'] }}-required"
		   class="col-md-2 col-form-label text-right">
	      Required</label>
	    <div class="col-md">
	      <div class="form-check">
		<input type="checkbox" id="{{ field['identifier'] }}-required"
		       name="required"
		       class="form-check-input"
		       value="true"
		       {{ field.get('required') and 'checked' or '' }}>
		<label class="form-check-label"
		       for="{{ field['identifier'] }}-required">
		  Yes</label>
	      </div>
	      <small id="{{ field['identifier'] }}-requiredHelp"
		     class="form-text text-muted">
		Is a field value required for a valid submission?
	      </small>
	    </div>
	  </div>
	  <div class="form-group row">
	    <label for="{{ field['identifier'] }}-description" 
		   class="col-md-2 col-form-label text-right">
	      Description</label>
	    <div class="col-md">
	      <textarea id="{{ field['identifier'] }}-description"
			name="description"
			class="form-control"
			aria-describedby="{{ field['identifier'] }}-descriptionHelp"
		>{{ field.get('description') or '' }}</textarea>
	      <small id="{{ field['identifier'] }}-descriptionHelp" 
		     class="form-text text-muted">
		<div class="row">
		  <div class="col-md">
		    Short description of the information to be entered
		    in the field.
		  </div>
		  <div class="col-md-4 text-right">
		    Formatted using 
		    <a href="{{ config['MARKDOWN_URL'] }}">Markdown</a>.
		  </div>
		</div>
	      </small>
	    </div>
	  </div>
	  {% if field['type'] in ('text', 'line') %}
	  <div class="form-group row">
	    <label for="{{ field['identifier'] }}-maxlength" 
		   class="col-md-2 col-form-label text-right">
	      Maxlength</label>
	    <div class="col-md">
	      <input type="text" id="{{ field['identifier'] }}-maxlength"
		     name="maxlength"
		     class="form-control"
		     aria-describedby="{{ field['identifier'] }}-maxlengthHelp"
		     value="{{ field.get('maxlength') or '' }}">
	      <small id="{{ field['identifier'] }}-maxlengthHelp"
		     class="form-text text-muted">
		Max number of characters.
	      </small>
	    </div>
	  </div>
	  {% endif %}
	</div>
	<div class="modal-footer">
          <button type="button" class="btn btn-secondary"
		  data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
	</div>
      </form>
    </div>
  </div>
</div>
{% endfor %} {# for field in call['fields'] #}

{% endif %} {# if call['tmp'].is_editable #}
{% endblock %} {# block main #}

{% block actions %}
{% if call['tmp'].is_open %}
<div class="mt-4">
  <form action="{{ url_for('.submission', cid=call['identifier']) }}"
	method="POST">
    {{ csrf_token() }}
    <button type="submit" class="btn btn-block btn-primary">
      Create submission</button>
  </form>
</div>
{% endif %}
{% if call['tmp'].is_editable %}
<div class="mt-4">
  <a href="{{ url_for('.edit', cid=call['identifier']) }}"
     role="button" class="btn btn-primary btn-block">Edit</a>
</div>
{% endif %} {# if call['tmp'].is_editable #}
{% if g.is_admin %}
<div class="mt-4">
  <a href="{{ url_for('.reviewers', cid=call['identifier']) }}"
     role="button" class="btn btn-info btn-block">Edit reviewers</a>
</div>
<div class="mt-4">
  <a href="{{ url_for('.clone', cid=call['identifier']) }}"
     role="button" class="btn btn-info btn-block">Clone</a>
</div>
{% endif %} {# if g.is_admin #}
{% if call['tmp'].is_editable %}
<div class="mt-4">
  <form action="{{ url_for('.edit', cid=call['identifier']) }}"
	method="POST">
    {{ csrf_token() }}
    <input type="hidden" name="_http_method" value="DELETE">
    <button type="submit" class="btn btn-block btn-sm btn-danger"
	    onclick="return confirm('Really delete the call?')">
      Delete</button>
  </form>
</div>
{% endif %} {# if call['tmp'].is_editable #}
{% endblock %} {# block actions #}

{% block info %}
{% if g.is_admin %}
<div class="small">
  Modified <span class="localtime">{{ call['modified'] }}</span>
  <span class="ml-4">
    Created <span class="localtime">{{ call['created'] }}</span>
  </span>
  <span class="ml-4">
    <a href="{{ url_for('.logs', cid=call['identifier']) }}">Logs</a>
  </span>
</div>
{% endif %} {# if g.is_admin #}
{% endblock %} {# block info #}

{% block javascript %}
<script>
$(".custom-file-input").on("change", function() {
  var fileName = $(this).val().split("\\").pop();
  $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
});
</script>{% endblock %}
